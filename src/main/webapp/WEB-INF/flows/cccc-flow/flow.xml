<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
		http://www.springframework.org/schema/webflow 
		http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <var class="com.cclife.registration.domain.RegistrationForm"
         name="form" />
    
    <on-start>
        <evaluate expression="registrationController.initializeForm()" result="form" />
    </on-start>
    
    <view-state id="step1" model="form" view="cccc/step1">
        <transition on="next" to="createNewOrSkip"/> 
        <transition on="cancel" to="cancel" validate="false"/>
    </view-state>
    
    <decision-state id="createNewOrSkip">
        <if test="form.registrants == null || form.registrants.isEmpty() " then="createNew" else="step3" />
    </decision-state>

    <action-state id="createNew">
        <evaluate expression="registrationController.createNewPerson(form)" 
                  result="flowScope.registrant" />
        <transition to="step2" />
    </action-state>
    
    <view-state id="step2" model="registrant" view="cccc/step2">
        <transition on="previous" to="step1"/>
        <transition on="next" to="step3"/> 
        <transition on="cancel" to="removeNew" validate="false"/>
    </view-state>
    
    <action-state id="removeNew">
        <evaluate expression="registrationController.removeNewPerson(form)"  />
        <transition to="step3" />
    </action-state>

    <view-state id="step3" model="form" view="cccc/step3">
        <transition on="previous" to="step1"/>
        <transition on="new" to="createNew"/>
        <transition on="next" to="calculateFee"/>
        <transition on="cancel" to="cancel"/>
        <transition on="edit" to="editPerson"/>
        <transition on="remove" to="deletePerson"/>
    </view-state>
    
    <action-state id="editPerson">
        <evaluate expression="registrationController.editPerson(flowScope.form, currentEvent.attributes)" result="flowScope.registrant" />
        <transition to="step2"/>
    </action-state>
    
    <action-state id="deletePerson">
        <evaluate expression="registrationController.deletePerson(flowScope.form, currentEvent.attributes)" />
        <transition to="step3"/>
    </action-state>
    
    <action-state id="calculateFee">
        <evaluate expression="registrationController.calculateFee(form)"  />
        <transition to="review" />
    </action-state>
    
    <view-state id="review" model="form" view="cccc/review">
        <transition on="previous" to="step3" validate="false"/>
        <transition on="next" to="payment"/>
        <transition on="cancel" to="cancel" validate="false"/>
    </view-state>

    <decision-state id="payment">
        <if test="form.paymentMethod == form.paymentMethod.PERSONAL_CHECK" then="prepareCheck"/>
        <if test="form.paymentMethod == form.paymentMethod.CREDIT_CARD" then="prepareCredit"/>
    </decision-state>

    <action-state id="prepareCredit">
        <evaluate expression="registrationController.getPaymentProviderUrl(flowRequestContext)"
                  result="flowScope.paymentUrl"/>
        <transition to="confirmAndPayByCredit">
            <evaluate expression="registrationController.createPaymentRequest(form)" result="flowScope.paymentProvider"/>
        </transition>
    </action-state>
    
    <action-state id="prepareCheck">
        <evaluate expression="registrationController.submit(form)"/>
        <transition to="confirmAndPayByCheck"/>
    </action-state>

    <end-state id="confirmAndPayByCheck" view="cccc/confirmAndPayByCheck" />
    <end-state id="confirmAndPayByCredit" view="cccc/confirmAndPayByCredit" />
    
    <end-state id="success" view="cccc/success"/>
    <end-state id="cancel" view="cccc/cancel"/>

</flow>